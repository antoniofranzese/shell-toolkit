#!/bin/zsh

ME=$(basename $0)
CMDLINE=$*

reload() {
	echo 'Press any key to continue...'
	read -k1 -s
	eval $ME $CMDLINE
}

case $1 in

	preview)
		shift
		NAME=$1
		LOCAL_MOD=${2[1]}
		REMOTE_MOD=${2[9]}
		if [ "$REMOTE_MOD" = "*" ]; then
			#HEAD=$($SVN info $NAME 2>&1 | grep "^Relative URL:" | cut -d" " -f3)\@HEAD
			#eval $SVN diff $NAME $HEAD | delta --file-style omit --hunk-header-style omit --paging never --line-numbers
			svn preview $NAME head
		else
			svn preview $NAME
		fi
		;;
	
	*)
		OUT=$(svn changes remote \
			| fzf -m \
				--no-sort \
				--header=$'\n''^U=Update ^R=Revert ^Space=Select all' \
				--header-lines=2 \
				--bind='ctrl-space:select-all' \
				--expect="ctrl-u,ctrl-r" \
				--preview="$ME preview {4} {2}" \
			| tr -s ' '
		)
		KEY=$(head -1 <<< $OUT)
		ROWS=$(tail -n +2 <<< $OUT)

		case "$KEY" in

			ctrl-u)
				while read ROW; do
					ARGS=( ${(s. .)ROW} )
					STATUS=${ARGS[2]}
					REMOTE_MOD=${STATUS[9]}
					NAME=${ARGS[4]}
				
					if [ "$REMOTE_MOD" != "-" ]; then
						echo Updating $NAME
						$SVN update $NAME 
					else
						echo Skipping $NAME
					fi
					
				done <<< $(echo $ROWS) 
				reload
				;;

			ctrl-r)
				while read ROW; do
					ARGS=( ${(s. .)ROW} )
					STATUS=${ARGS[2]}
					LOCAL_MOD=${STATUS[1]}
					NAME=${ARGS[4]}
				
					if [ "$LOCAL_MOD" != "-" ]; then
						echo Reverting $NAME
						$SVN revert $NAME 
					else
						echo Skipping $NAME
					fi
					
				done <<< $(echo $ROWS) 
				reload
				;;

			*)
				#echo Other
				;;

		esac
		;;
				
esac
