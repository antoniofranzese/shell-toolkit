#!/bin/zsh

ME=$(basename $0)
FZF=(-m --preview-window="up:70%" --preview="svn preview {2}")

case $1 in
	list)
		NAME=${2:-\/}

		if [ "$NAME" = "/" ]; then
			$SVN status | sed "/--- Changelist/,$ d" | grep -v "^\\?" | grep -v -e '^$'
		else
			$SVN status | sed -n "/--- Changelist '$NAME'/,/--- Changelist/ p" | grep -v "\--- Changelist" | grep -v -e '^$'
		fi
		;;

	lists)
		[ $( $SVN status | wc -l ) -gt 0 ] && echo \/
		$SVN status | grep "\--- Changelist" | awk '{print $3}' | sed -e "s/^'\([^']*\)':/\1/"
		;;

	add)
		TARGET=$2

		[ -z $TARGET ] && echo "Missing target list" && exit 1
		[ "$TARGET" = "/" ] && echo "Cannot add to root list" && exit 1
		[ $( $0 list / | wc -l ) -eq 0 ] && echo "Nothing to add" && exit 0

		$0 list / \
			| fzf ${FZF[@]} \
			| awk '{ print $2 }' \
			| xargs -n1 $SVN changelist $TARGET
		;;

			#| fzf -m --preview-window="up:70%" --preview="$PREVIEW" \
	remove)
		SOURCE=$2

		[ -z $SOURCE ] && echo "Missing source list" && exit 1
		[ "$SOURCE" = "/" ] && echo "Cannot remove from root list" && exit 1
		[ $( $0 list $SOURCE | wc -l ) -eq 0 ] && echo "Nothing to remove" && exit 0

		$0 list $SOURCE \
			| fzf ${FZF[@]} \
			| awk '{ print $2 }' \
			| xargs -n1 $SVN changelist --remove $TARGET
		;;

	commit)
		$SVN commit --changelist $2
		;;

	preview)
		$ME \
			| fzf \
				--header-lines=1 \
				--preview="svn preview {4}"
		;;
	
	update)
		$ME remote \
			| fzf \
				--header-lines=1 \
				--preview="$ME remote diff {2} {4}"
		;;

	remote)
		LEN=$( $0 lists | awk '{print length}' | sort -nr | head -1 )
		LS=/
		while read LINE; do
			if [[ "$LINE" =~ ^#\--- ]]; then
				LS=$( echo $LINE | awk '{print $3}' | sed -e "s/^'\([^']*\)':/\1/" )
			elif [[ "$LINE" =~ ^#(Revision|Status) ]]; then
				echo $LINE[2,-1]
			else
				STATUS=$( echo ${LINE[2,11]} | sed -e "s/\ /-/g" )
				REV=$( echo ${LINE[13,19]} | xargs )
				printf "%-${LEN}s  %s %6s %s" "$LS" "$STATUS" "${REV:-?}" "${LINE[22,-1]}"
				echo
			fi
		done <<< $( svn status -u | grep -v "^$" | sed -e "s/^/#/" )
		;;

	"")
		LEN=$( $0 lists | awk '{print length}' | sort -nr | head -1 )
		LS=/
		while read LINE; do
			if [[ "$LINE" =~ ^\--- ]]; then
				LS=$( echo $LINE | awk '{print $3}' | sed -e "s/^'\([^']*\)':/\1/" )
			elif [[ "$LINE" =~ ^Revision ]]; then
				echo $LINE
			else
				STATUS=$( echo ${LINE[1,7]} | sed -e "s/\ /-/g" )
				REV=$( $SVN info ${LINE[9,-1]} 2>&1 | egrep "^Revision:" | awk '{print $2}' )
				printf "%-${LEN}s  %s--- %6s %s" "$LS" "$STATUS" "${REV:-?}" "${LINE[8,-1]}"
				echo
			fi
		done <<< $( svn status | grep -v "^$" )
		;;

	*)
		echo Unknown $ME command: $1
esac
